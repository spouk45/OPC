{% extends 'base.html.twig' %}
{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('build/map.css') }}">
{% endblock %}

{% block body %}
    <div id="map" data-customers="{{ customers }}"></div>
{% endblock %}
{% block javascripts %}

    <script>
        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'));
            // Create an array of alphabetical characters used to label the markers.
            // const labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

            // Add some markers to the map.
            // Note: The code uses the JavaScript Array.prototype.map() method to
            // create an array of markers based on a given "locations" array.
            // The map() method here has nothing to do with the Google Maps API.
            const bounds = new google.maps.LatLngBounds();

            let markers = extractMarker(customersData, bounds);

            map.fitBounds(bounds);
            map.panToBounds(bounds);

            // Add a marker clusterer to manage the markers.
            let markerCluster = new MarkerClusterer(map, markers,
                {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'}
            );
        }

        function extractMarker(data, bounds) {
            let markers = [];
            for (let color in data) {
                console.log(color);
                for (let k in data[color]) {
                    let customer = data[color][k];
                    let icon = color + '.png';
                    let loc = new google.maps.LatLng(customer.location.lat, customer.location.lng);
                    bounds.extend(loc);
                    let marker = new google.maps.Marker({
                        position: loc,
                        title: customer.fullName,
                        icon: 'img/' + icon,
                    });
                    let contentString = '<b>Adresse :</b> ' + customer.fullAdress + '<br> <b>Date d\'anniversaire de contrat : </b>'
                        + customer.annivContratDate + '<br> <b>Denière maintenance : </b> '+ customer.lastMaintenanceDate +
                        '<p class="mt-1 text-center"><a href="/customer/' + customer.id + '">Fiche client</a></p>';
                    if (color == 'blue') {
                        contentString = '<b> Plannifié le :</b> ' + customer.planned + '<br>' + contentString;
                    }

                    let infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });

                    marker.addListener('click', function () {
                        infowindow.open(map, marker);
                    });
                    markers.push(marker);
                }
            }
            return markers;
        }

        let customersData = JSON.parse($('#map').attr('data-customers'));

    </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key={{ apiKey }}&callback=initMap">
    </script>
{% endblock %}